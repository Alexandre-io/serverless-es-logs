{
  "ServerlessEsLogsFirehose": {
    "Type": "AWS::KinesisFirehose::DeliveryStream",
    "DependsOn": [
      "ServerlessEsLogsS3",
      "ServerlessEsLogsLogGroup",
      "ServerlessEsLogsEsLogStream",
      "ServerlessEsLogsS3LogStream",
      "ServerlessEsLogsIAMRole",
      "EsLogsProcesserLambdaFunction"
    ],
    "Properties": {
      "DeliveryStreamName": "",
      "DeliveryStreamType": "DirectPut",
      "ElasticsearchDestinationConfiguration": {
        "RoleARN": {
          "Fn::GetAtt": [
            "ServerlessEsLogsIAMRole",
            "Arn"
          ]
        },
        "DomainARN": "",
        "IndexName": "serverless-es-logs",
        "TypeName": "serverless-es-logs",
        "IndexRotationPeriod": "OneDay",
        "BufferingHints": {
          "IntervalInSeconds": 60,
          "SizeInMBs": 3
        },
        "RetryOptions": {
          "DurationInSeconds": 60
        },
        "S3BackupMode": "FailedDocumentsOnly",
        "S3Configuration": {
          "RoleARN": {
            "Fn::GetAtt": [
              "ServerlessEsLogsIAMRole",
              "Arn"
            ]
          },
          "BucketARN": {
            "Fn::GetAtt": [
              "ServerlessEsLogsS3",
              "Arn"
            ]
          },
          "BufferingHints": {
            "IntervalInSeconds": 60,
            "SizeInMBs": 3
          },
          "CompressionFormat": "UNCOMPRESSED",
          "EncryptionConfiguration": {
            "NoEncryptionConfig": "NoEncryption"
          },
          "CloudWatchLoggingOptions": {
            "Enabled": true,
            "LogGroupName": {
              "Ref": "ServerlessEsLogsLogGroup"
            },
            "LogStreamName": {
              "Ref": "ServerlessEsLogsS3LogStream"
            }
          }
        },
        "ProcessingConfiguration": {
          "Enabled": true,
          "Processors": [
            {
              "Type": "Lambda",
              "Parameters": [
                {
                  "ParameterName": "LambdaArn",
                  "ParameterValue": {
                    "Fn::GetAtt": [
                      "EsLogsProcesserLambdaFunction",
                      "Arn"
                    ]
                  }
                },
                {
                  "ParameterName": "NumberOfRetries",
                  "ParameterValue": "3"
                },
                {
                  "ParameterName": "RoleArn",
                  "ParameterValue": {
                    "Fn::GetAtt": [
                      "ServerlessEsLogsIAMRole",
                      "Arn"
                    ]
                  }
                },
                {
                  "ParameterName": "BufferSizeInMBs",
                  "ParameterValue": "3"
                },
                {
                  "ParameterName": "BufferIntervalInSeconds",
                  "ParameterValue": "60"
                }
              ]
            }
          ]
        },
        "CloudWatchLoggingOptions": {
          "Enabled": true,
          "LogGroupName": {
            "Ref": "ServerlessEsLogsLogGroup"
          },
          "LogStreamName": {
            "Ref": "ServerlessEsLogsEsLogStream"
          }
        }
      }
    }
  }
}